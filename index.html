</html><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>HistaBase - Histamine Food Tracker</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon-256x256.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    /* Custom checkbox styling */
    input[type="checkbox"] {
      accent-color: #525174;
    }
    input[type="checkbox"]:checked {
      background-color: #525174;
      border-color: #525174;
    }
    input[type="checkbox"]:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(82, 81, 116, 0.2);
    }

    /* Mobile overlay sidebar */
    @media (max-width: 768px) {
      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        background: white;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }
      
      .mobile-sidebar.open {
        transform: translateX(0);
      }
      
      .mobile-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
      }
      
      .mobile-backdrop.open {
        display: block;
      }

      .desktop-sidebar {
        display: none;
      }

      .main-content {
        max-width: 100% !important;
        padding: 0 1rem !important;
      }

      /* Better mobile spacing */
      .mobile-header {
        padding: 1rem;
      }

      /* Adjust food cards for mobile */
      .food-card-mobile {
        font-size: 0.9rem;
      }

      /* Fix food card layout for mobile - stack vertically */
      .food-card-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .food-card-top {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
      }

      .food-card-name-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
      }

      .food-card-badges-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
      }

      .food-card-name {
        font-size: 0.95rem !important;
        flex: 1;
        min-width: 0;
      }

      .food-card-badge {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
        white-space: nowrap;
      }

      /* On mobile, reorganize the card layout */
      .food-card-inner {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.75rem !important;
      }

      .food-card-first-row {
        display: flex;
        align-items: center;
        width: 100%;
        gap: 0.5rem;
      }

      .food-card-second-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      /* Make badges smaller */
      .food-card-second-row span {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
        min-width: auto !important;
      }

      /* Stack login button on mobile */
      .mobile-auth-buttons {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
      /* Floating show filters button */
      
      
      /* Floating filter menu icon button */
      .floating-filter-icon {
        position: fixed;
        top: 1rem;
        left: 20px;
        z-index: 500;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 2px solid rgba(82, 81, 116, 0.2);
        background-color: transparent;
        cursor: pointer;
        transition: opacity 0.3s ease, border-color 0.3s ease;
      }
      
      .floating-filter-icon:hover {
        border-color: rgba(82, 81, 116, 0.4);
      }

    /* Desktop only - keep sidebar visible */
    @media (min-width: 769px) {
      .mobile-sidebar {
        display: none;
      }
      
      .desktop-sidebar {
        display: block;
      }

      .mobile-backdrop {
        display: none !important;
      }
    }
  </style>

  <style id="light-dark-theme">
    /* SUBTLE OFF-WHITE THEME - Warm and inviting */
    body {
      background-color: #FAF9F7 !important;
    }
    
    /* Main background areas - warm off-white */
    .bg-gray-100,
    .min-h-screen {
      background-color: #faf6f5 !important;
    }
    
    /* Cards - warm off-white */
    .bg-white {
      background-color: #FFFEFB !important;
      border-color: #E8E6E3 !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    
    /* Keep original text colors */
    
    /* Borders - warm subtle */
    .border-gray-100 {
      border-color: #F0EEE9 !important;
    }
    
    .border-gray-200 {
      border-color: #E8E6E3 !important;
    }
    
    /* Input fields - warm slight tint */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    select,
    textarea {
      background-color: #FDFCFA !important;
      border-color: #E8E6E3 !important;
    }
    
    /* Sidebar - warm slight tint */
    .bg-gray-50 {
      background-color: #faf8fc !important;
    }
    
    /* Category dividers */
    .bg-gray-200 {
      background-color: #F0EEE9 !important;
    }
    
    /* Subtle shadows */
    button {
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* Remove shadow from voting buttons */
    .vote-button {
      box-shadow: none !important;
      border: none !important;
    }
    
    /* Remove shadow from language buttons */
    .language-button {
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Initialize Supabase
    const supabaseUrl = 'https://iwczofbamtrppolrytab.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3Y3pvZmJhbXRycHBvbHJ5dGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Mzk5MzEsImV4cCI6MjA3OTQxNTkzMX0.Fvp59JvXSg8mGZNn_fLokrdF6_Y7HfFvW2ZpuKCfYWI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // Lucide icons as inline SVG components
    const Search = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
    const User = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
    const Info = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
    const AlertCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
    const CheckCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
    const XCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
    const HelpCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>;
    const ChevronDown = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;
    const ChevronUp = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>;
    const Users = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
    const Filter = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
    const ExternalLink = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>;
    const Heart = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
    const Mail = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>;
    const Download = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
    const ArrowUpDown = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg>;
    const LogOut = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
    const LogIn = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>;

    // Database URLs
    const DATABASE_URL_EN = 'https://gist.githubusercontent.com/lgqbc/58c82d7d2c3440c824a98b92927e597d/raw/FoodDatabaseExtended.json';
    const DATABASE_URL_DE = 'https://gist.githubusercontent.com/lgqbc/9536daa095a866617edb1c14df15608d/raw/b3569c67237078d792fbb7da9a9ee208c613d873/foodDatabase_german.json';

    const allSources = ["SIGHI", "FDA", "USDA", "CFCD"];
    const sourceLinks = { 
      "SIGHI": "https://www.histaminintoleranz.ch/en/", 
      "FDA": "https://www.fda.gov/", 
      "USDA": "https://fdc.nal.usda.gov/",
      "CFCD (No Histamine Data)": "https://www.nutridatabaze.cz/en/search-food-data/alphabetical-list/?letter=/" 
    };
    
    const translations = {
      en: {
        // Info section
        aboutTitle: "About Histamine Intolerance",
        aboutP1: "Histamine intolerance occurs when there's an imbalance between histamine intake and the body's ability to break it down.",
        aboutP2: "Everyone is different! What triggers symptoms in one person may be fine for another.",
        aboutP3: "HistaBase combines research and user reports to help you track which foods affect your histamine levels and keep a personalized log of your reactions.",
        sourcesTitle: "Our Sources",
        contactTitle: "Contact",
        contactText: "Questions?",
        contactEmail: "hello@histabase.com",
        supportTitle: "Support HistaBase",
        supportText: "Help us maintain this free resource.",
        donateButton: "Donate",
        
        // Navigation
        database: "Database",
        profile: "Profile",
        info: "Info",
        
        // Sidebar/Filters
        filters: "Filters",
        language: "Language",
        diet: "Diet",
        categories: "Categories",
        sources: "Sources",
        allFoods: "All Foods",
        vegetarian: "Vegetarian",
        vegan: "Vegan",
        
        // Profile section
        account: "Account",
        loggedInAs: "Logged in as:",
        yourConditions: "Your Conditions",
        defaultDiet: "Default Diet",
        defaultLanguage: "Default Language",
        chooseDietFilter: "Choose your default diet filter for the database",
        
        // Ratings section
        yourRatings: "Your Ratings",
        downloadPDF: "Download as PDF",
        whatICanEat: "What I Can Eat",
        inModeration: "In Moderation",
        whatIShouldAvoid: "What I Should Avoid",
        iCanEat: "I Can Eat",
        noneYet: "None yet",
        
        // About ratings
        aboutYourRatings: "About Your Ratings",
        canEatDesc: "Foods you tolerate well without symptoms",
        moderationDesc: "Foods that are okay in small amounts or occasionally",
        avoidDesc: "Foods that trigger symptoms",
        allVotesAnonymous: "All votes are anonymous and help build community insights.",
        
        // PDF titles
        allMyRatings: "All My Ratings",
        myConditions: "My Conditions",
        
        // Modal
        setConditionsFirst: "Set Your Conditions First",
        selectCondition: "Select at least one condition to rate foods.",
        goToProfile: "Go to Profile"
      },
      de: {
        // Info section
        aboutTitle: "ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œber HistaminunvertrÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤glichkeit",
        aboutP1: "HistaminunvertrÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤glichkeit tritt auf, wenn ein Ungleichgewicht zwischen der Histaminaufnahme und der FÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤higkeit des KÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¶rpers besteht, dieses abzubauen.",
        aboutP2: "Jeder ist anders! Was bei einer Person Symptome auslÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¶st, kann fÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¼r eine andere in Ordnung sein.",
        aboutP3: "HistaBase kombiniert Forschung und Benutzerberichte, um dir zu helfen, nachzuverfolgen, welche Lebensmittel deine Histaminspiegel beeinflussen, und ein persÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¶nliches Reaktionstagebuch zu fÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¼hren.",
        sourcesTitle: "Unsere Quellen",
        contactTitle: "Kontakt",
        contactText: "Fragen?",
        contactEmail: "hello@histabase.com",
        supportTitle: "HistaBase unterstÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¼tzen",
        supportText: "Hilf uns, diese kostenlose Ressource zu pflegen.",
        donateButton: "Spenden",
        
        // Navigation
        database: "Datenbank",
        profile: "Profil",
        info: "Info",
        
        // Sidebar/Filters
        filters: "Filter",
        language: "Sprache",
        diet: "ErnÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤hrung",
        categories: "Kategorien",
        sources: "Quellen",
        allFoods: "Alle Lebensmittel",
        vegetarian: "Vegetarisch",
        vegan: "Vegan",
        
        // Profile section
        account: "Konto",
        loggedInAs: "Angemeldet als:",
        yourConditions: "Deine Bedingungen",
        defaultDiet: "StandardernÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤hrung",
        defaultLanguage: "Standardsprache",
        chooseDietFilter: "WÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤hle deinen Standard-ErnÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤hrungsfilter fÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¼r die Datenbank",
        
        // Ratings section
        yourRatings: "Deine Bewertungen",
        downloadPDF: "PDF herunterladen",
        whatICanEat: "Was ich essen kann",
        inModeration: "In MaÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸en",
        whatIShouldAvoid: "Was ich vermeiden sollte",
        iCanEat: "Was ich essen kann",
        noneYet: "Noch keine",
        
        // About ratings
        aboutYourRatings: "ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œber deine Bewertungen",
        canEatDesc: "Lebensmittel, die du gut vertrÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤gst, ohne Symptome",
        moderationDesc: "Lebensmittel, die in kleinen Mengen oder gelegentlich in Ordnung sind",
        avoidDesc: "Lebensmittel, die Symptome auslÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¶sen",
        allVotesAnonymous: "Alle Abstimmungen sind anonym und helfen beim Aufbau von Community-Erkenntnissen.",
        
        // PDF titles
        allMyRatings: "Alle meine Bewertungen",
        myConditions: "Meine Bedingungen",
        
        // Modal
        setConditionsFirst: "Richte zuerst deine Bedingungen ein",
        selectCondition: "WÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤hle mindestens eine Bedingung aus, um Lebensmittel zu bewerten.",
        goToProfile: "Zum Profil gehen"
      }
    };
    
    const conditions = ["Histamine Intolerance", "MCAS", "DAO Deficiency", "IBS", "Chronic Urticaria", "Migraine", "Eczema", "Asthma"];
    const categories = ["Vegetables", "Fruits", "Meat", "Seafood", "Dairy", "Grains", "Legumes", "Nuts & Seeds", "Fermented", "Beverages", "Oils & Fats", "Condiments", "Sweets", "Eggs", "Spices"];

    // Flag icons as inline SVG components
    const FlagUS = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30">
        <clipPath id="s"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
        <clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath>
        <g clipPath="url(#s)">
          <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" strokeWidth="6"/>
          <path d="M0,0 L60,30 M60,0 L0,30" clipPath="url(#t)" stroke="#C8102E" strokeWidth="4"/>
          <path d="M30,0 v30 M0,15 h60" stroke="#fff" strokeWidth="10"/>
          <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" strokeWidth="6"/>
        </g>
      </svg>
    );

    const FlagDE = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30">
        <rect width="60" height="10" fill="#000"/>
        <rect width="60" height="10" y="10" fill="#D00"/>
        <rect width="60" height="10" y="20" fill="#FFCE00"/>
      </svg>
    );

    // Fuzzy search helper - calculates similarity between two strings
    function fuzzyMatch(str, query) {
      str = str.toLowerCase();
      query = query.toLowerCase();
      
      // Exact match
      if (str.includes(query)) return 1;
      
      // Calculate Levenshtein distance for typo tolerance
      const matrix = [];
      for (let i = 0; i <= query.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= str.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= query.length; i++) {
        for (let j = 1; j <= str.length; j++) {
          if (query.charAt(i - 1) === str.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // substitution
              matrix[i][j - 1] + 1,     // insertion
              matrix[i - 1][j] + 1      // deletion
            );
          }
        }
      }
      
      const distance = matrix[query.length][str.length];
      const maxLength = Math.max(str.length, query.length);
      
      // Return similarity score (0 to 1)
      return 1 - (distance / maxLength);
    }

    // Simple in-memory storage (removed - using Supabase now)

    function BarGraph(props) {
      const total = props.tolerable + props.moderate + props.intolerable;
      const tolPct = total > 0 ? (props.tolerable / total) * 100 : 0;
      const modPct = total > 0 ? (props.moderate / total) * 100 : 0;
      const intPct = total > 0 ? (props.intolerable / total) * 100 : 0;
      
      return (
        <div className={props.isTotal ? "mb-3 pb-3 border-b border-gray-200" : "mb-1"}>
          <div className="flex justify-between text-sm mb-1">
            <span className={props.isTotal ? "font-semibold text-gray-800" : "text-gray-600"}>{props.label}</span>
            <span className="text-gray-400">{total > 0 ? Math.round(tolPct) + "%" : "No data"} % {total}</span>
          </div>
          <div className="flex h-5 rounded-full overflow-hidden bg-gray-200">
            {props.tolerable > 0 && <div style={{ width: tolPct + "%", backgroundColor: '#00A676' }} />}
            {props.moderate > 0 && <div style={{ width: modPct + "%", backgroundColor: '#FBAF00' }} />}
            {props.intolerable > 0 && <div style={{ width: intPct + "%", backgroundColor: '#BB342F' }} />}
          </div>
        </div>
      );
    }

    function HistaBase() {
      const [foodDatabase, setFoodDatabase] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [language, setLanguage] = useState("en");
      const [defaultLanguage, setDefaultLanguage] = useState("en");
      
      const [search, setSearch] = useState("");
      const [expanded, setExpanded] = useState(null);
      const [view, setView] = useState("database");
      const [userConditions, setUserConditions] = useState(["Histamine Intolerance"]);
      const [communityRatings, setCommunityRatings] = useState({});
      const [myRatings, setMyRatings] = useState({});
      const [showModal, setShowModal] = useState(false);
      const [selectedSources, setSelectedSources] = useState(allSources);
      const [selectedCategories, setSelectedCategories] = useState(categories);
      const [dietFilter, setDietFilter] = useState("all");
      const [defaultDiet, setDefaultDiet] = useState("all");
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [mobileSidebarOpen, setMobileSidebarOpen] = useState(false);
      const [showDownloadMenu, setShowDownloadMenu] = useState(false);
      const [sortBy, setSortBy] = useState("score");
      const [sortDirection, setSortDirection] = useState("asc"); // "asc" or "desc" - start with asc so safe foods (0) are first
      const [categorySort, setCategorySort] = useState(false); // separate category grouping toggle
      const [isFilterButtonFloating, setIsFilterButtonFloating] = useState(false);
      const filterButtonRef = React.useRef(null);

      // Authentication state
      const [user, setUser] = useState(null);
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [authMode, setAuthMode] = useState("login"); // "login" or "signup"
      const [authEmail, setAuthEmail] = useState("");
      const [authPassword, setAuthPassword] = useState("");
      const [authError, setAuthError] = useState("");
      const [authLoading, setAuthLoading] = useState(false);
      
      // Use ref to track if we're currently loading data
      const isLoadingDataRef = useRef(false);
      const hasLoadedInitialDataRef = useRef(false);

      // Load food database from external URL
      useEffect(() => {
        async function loadDatabase() {
          try {
            setLoading(true);
            const url = language === "en" ? DATABASE_URL_EN : DATABASE_URL_DE;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load database');
            const data = await response.json();
            setFoodDatabase(data);
            setLoading(false);
          } catch (err) {
            setError(err.message);
            setLoading(false);
          }
        }
        loadDatabase();
      }, [language]);

      // Check authentication state on mount  
      useEffect(() => {
        let mounted = true;
        let initialCheckDone = false;
        
        async function checkAuth() {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user && mounted) {
            console.log('[MOUNT] Session found, loading user data...');
            setUser(session.user);
            await loadUserData(session.user.id);
          } else {
            // No user logged in - still load community ratings
            console.log('[MOUNT] No session, loading community ratings only...');
            await loadCommunityRatings();
          }
          initialCheckDone = true;
          console.log('[MOUNT] Initial check complete');
        }
        checkAuth();

        // Listen for auth changes
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('[AUTH] Event:', event, 'InitialCheckDone:', initialCheckDone);
          
          // Ignore events until initial check is done
          if (!initialCheckDone) {
            console.log('[AUTH] Ignoring event (initial check not done)');
            return;
          }
          
          if (event === 'SIGNED_IN' && session?.user && mounted) {
            console.log('[AUTH] User signed in, loading data...');
            setUser(session.user);
            await loadUserData(session.user.id);
          } else if (event === 'SIGNED_OUT' && mounted) {
            console.log('[AUTH] User signed out, clearing data...');
            setUser(null);
            setUserConditions(["Histamine Intolerance"]);
            setMyRatings({});
            setDefaultDiet("all");
            setDefaultLanguage("en");
            setLanguage("en");
            await loadCommunityRatings();
          }
        });

        return () => {
          mounted = false;
          subscription.unsubscribe();
        };
      }, []);

      // Load user data from Supabase
      async function loadUserData(userId) {
        console.log('[DATA] Starting to load data for user:', userId);
        
        try {
          // Load user profile - no timeout, let Supabase handle it
          console.log('[DATA] Querying profiles table...');
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();

          if (profileError) {
            console.error('[DATA] Profile load error:', profileError);
            // Don't fail completely, just use defaults
          } else {
            console.log('[DATA] Profile loaded successfully:', profile);
          }

          if (profile) {
            setUserConditions(profile.conditions || ["Histamine Intolerance"]);
            setDefaultDiet(profile.default_diet || "all");
            setDietFilter(profile.default_diet || "all");
            setDefaultLanguage(profile.default_language || "en");
            setLanguage(profile.default_language || "en");
          }

          // Load user's ratings - no timeout
          console.log('[DATA] Querying food_ratings table...');
          const { data: ratings, error: ratingsError } = await supabase
            .from('food_ratings')
            .select('*')
            .eq('user_id', userId);

          if (ratingsError) {
            console.error('[DATA] Ratings load error:', ratingsError);
            // Don't fail completely, just use empty ratings
          } else {
            console.log('[DATA] Ratings fetched:', ratings?.length || 0, 'found');
          }

          const myRatingsObj = {};
          if (ratings && ratings.length > 0) {
            ratings.forEach(r => {
              myRatingsObj[r.food_id] = {
                rating: r.rating,
                conditions: r.conditions || []
              };
            });
            console.log(`[DATA] Loaded ${ratings.length} ratings into state`);
          } else {
            console.log('[DATA] No ratings to load');
          }
          setMyRatings(myRatingsObj);
          console.log('[DATA] setMyRatings called');

          // Load all community ratings
          console.log('[DATA] Loading community ratings...');
          await loadCommunityRatings();
          console.log('[DATA] loadUserData complete!');
        } catch (err) {
          console.error('[DATA] CRITICAL ERROR in loadUserData:', err);
          // Set defaults so UI isn't broken - don't clear existing state
          if (Object.keys(myRatings).length === 0) {
            setMyRatings({});
          }
        }
      }

      // Load community ratings from Supabase
      async function loadCommunityRatings() {
        try {
          const { data: allRatings } = await supabase
            .from('food_ratings')
            .select('food_id, rating, conditions');

          const communityObj = {};
          if (allRatings) {
            allRatings.forEach(r => {
              if (!communityObj[r.food_id]) {
                communityObj[r.food_id] = [];
              }
              communityObj[r.food_id].push({
                rating: r.rating,
                conditions: r.conditions || []
              });
            });
          }
          setCommunityRatings(communityObj);
        } catch (err) {
          console.error('Error loading community ratings:', err);
        }
      }

      // Load user data from storage
      useEffect(() => {
        async function load() {
          // Removed localStorage - now using Supabase
        }
        load();
      }, []);

      // Save user data to Supabase
      useEffect(() => {
        async function save() {
          if (!user) return;
          
          try {
            // Update profile
            await supabase
              .from('profiles')
              .upsert({
                id: user.id,
                conditions: userConditions,
                default_diet: defaultDiet,
                default_language: defaultLanguage
              });
          } catch (e) {
            console.error('Error saving profile:', e);
          }
        }
        save();
      }, [userConditions, defaultDiet, defaultLanguage, user]);

      // Handle floating filter button on mobile
      useEffect(() => {
        if (window.innerWidth > 768) return; // Only on mobile
        
        const handleScroll = () => {
          if (!filterButtonRef.current) return;
          
          // Get the button's position relative to the viewport
          const buttonRect = filterButtonRef.current.getBoundingClientRect();
          
          // Button should float if it's scrolled out of view (top of button goes above viewport)
          const shouldFloat = buttonRect.top < 0;
          setIsFilterButtonFloating(shouldFloat);
        };
        
        window.addEventListener('scroll', handleScroll);
        // Initial check
        handleScroll();
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);


      // Calculate user score percentage for a food
      function getUserScorePercentage(foodId) {
        const ratings = communityRatings[foodId];
        if (!ratings || ratings.length === 0) return null;
        
        let tolerable = 0;
        ratings.forEach(r => {
          if (r.rating === "tolerate") tolerable++;
        });
        
        // Simple percentage: tolerable / total (same as bar graph)
        const percentage = (tolerable / ratings.length) * 100;
        return Math.round(percentage);
      }

      function getFilteredFoods() {
        const filtered = foodDatabase.filter(f => {
          if (!f.sources.some(s => selectedSources.includes(s))) return false;
          if (!selectedCategories.includes(f.category)) return false;
          if (dietFilter === "vegetarian" && !f.veg) return false;
          if (dietFilter === "vegan" && !f.vegan) return false;
          
          if (search.trim()) {
            const q = search.toLowerCase();
            
            // Try exact/substring match first
            const nameMatch = f.name.toLowerCase().includes(q);
            const categoryMatch = f.category.toLowerCase().includes(q);
            const descMatch = f.description.toLowerCase().includes(q);
            
            if (nameMatch || categoryMatch || descMatch) return true;
            
            // Use fuzzy matching for typo tolerance (similarity > 0.6)
            const nameSimilarity = fuzzyMatch(f.name, q);
            const categorySimilarity = fuzzyMatch(f.category, q);
            const descSimilarity = fuzzyMatch(f.description, q);
            
            const threshold = 0.4; // Lower = more forgiving for typos
            if (nameSimilarity > threshold || categorySimilarity > threshold || descSimilarity > threshold) {
              return true;
            }
            
            return false;
          }
          
          return true;
        });

        // Apply sorting
        const sorted = filtered.sort((a, b) => {
          // Category grouping (if enabled, categories are grouped first)
          if (categorySort) {
            if (a.category !== b.category) {
              return a.category.localeCompare(b.category);
            }
            // Within same category, use the selected sorting
          }
          
          let comparison = 0;
          
          if (sortBy === "name") {
            comparison = a.name.localeCompare(b.name);
          } else if (sortBy === "userscore") {
            const aUserScore = getUserScorePercentage(a.id);
            const bUserScore = getUserScorePercentage(b.id);
            
            // Both have user scores - sort by user score
            if (aUserScore !== null && bUserScore !== null) {
              comparison = bUserScore - aUserScore;
            } else if (aUserScore !== null) {
              comparison = -1;
            } else if (bUserScore !== null) {
              comparison = 1;
            } else {
              // Neither has user score - fall back to official score
              if (a.score === b.score) comparison = 0;
              else if (a.score === -1) comparison = 1;
              else if (b.score === -1) comparison = -1;
              else comparison = a.score - b.score;
            }
          } else if (sortBy === "score") {
            // Database score sorting
            if (a.score === b.score) comparison = 0;
            else if (a.score === -1) comparison = 1;
            else if (b.score === -1) comparison = -1;
            else comparison = a.score - b.score;
          }
          
          // Apply sort direction
          return sortDirection === "asc" ? comparison : -comparison;
        });
        
        return sorted;
      }

      function handleColumnSort(column) {
        if (sortBy === column) {
          // Toggle direction
          setSortDirection(sortDirection === "asc" ? "desc" : "asc");
        } else {
          // New column, set to descending by default (except name which is ascending)
          setSortBy(column);
          setSortDirection(column === "name" ? "asc" : "desc");
        }
      }

      function getScoreColor(score) {
        if (score === -1) return "bg-gray-400";
        if (score === 0) return "bg-[#00A676]";
        if (score <= 2) return "bg-[#FBAF00]";
        return "bg-[#BB342F]";
      }

      function getScoreLabel(level) {
        if (level === "safe") return "Safe";
        if (level === "moderate") return "Moderate";
        if (level === "high") return "Avoid";
        return "No Data";
      }

      function getScoreIcon(level) {
        if (level === "safe") return <CheckCircle className="w-5 h-5" style={{ color: '#00A676' }} />;
        if (level === "moderate") return <AlertCircle className="w-5 h-5" style={{ color: '#FBAF00' }} />;
        if (level === "unknown") return <HelpCircle className="w-5 h-5 text-gray-400" />;
        return <XCircle className="w-5 h-5" style={{ color: '#BB342F' }} />;
      }

      function getUserScoreColor(percentage) {
        if (percentage >= 80) return "text-green-500";
        if (percentage >= 30) return "text-yellow-500";
        return "text-red-500";
      }

      function getCommunityStats(foodId) {
        const ratings = communityRatings[foodId];
        if (!ratings || ratings.length === 0) return null;
        
        const byCondition = {};
        let totalTol = 0, totalMod = 0, totalInt = 0;
        
        ratings.forEach(r => {
          if (r.rating === "tolerate") totalTol++;
          else if (r.rating === "moderation") totalMod++;
          else totalInt++;
          
          if (r.conditions) {
            r.conditions.forEach(c => {
              if (!byCondition[c]) byCondition[c] = { tolerable: 0, moderate: 0, intolerable: 0 };
              if (r.rating === "tolerate") byCondition[c].tolerable++;
              else if (r.rating === "moderation") byCondition[c].moderate++;
              else byCondition[c].intolerable++;
            });
          }
        });
        
        return { byCondition, total: { tolerable: totalTol, moderate: totalMod, intolerable: totalInt } };
      }

      async function submitRating(foodId, rating) {
        if (!user) {
          setShowAuthModal(true);
          return;
        }

        if (userConditions.length === 0) { 
          setShowModal(true); 
          return; 
        }
        
        const existing = myRatings[foodId];
        
        // Toggle off if clicking same rating
        if (existing && existing.rating === rating) {
          try {
            // Delete from database
            await supabase
              .from('food_ratings')
              .delete()
              .eq('user_id', user.id)
              .eq('food_id', foodId);

            // Update local state
            const newMyRatings = {...myRatings};
            delete newMyRatings[foodId];
            setMyRatings(newMyRatings);

            // Reload community ratings
            await loadCommunityRatings();
          } catch (err) {
            console.error('Error deleting rating:', err);
          }
          return;
        }
        
        // Update rating
        try {
          // Delete old rating if exists
          if (existing) {
            await supabase
              .from('food_ratings')
              .delete()
              .eq('user_id', user.id)
              .eq('food_id', foodId);
          }

          // Insert new rating
          await supabase
            .from('food_ratings')
            .insert({
              user_id: user.id,
              food_id: foodId,
              rating: rating,
              conditions: userConditions
            });

          // Update local state
          setMyRatings({
            ...myRatings,
            [foodId]: { 
              rating, 
              conditions: [...userConditions] 
            }
          });

          // Reload community ratings
          await loadCommunityRatings();
        } catch (err) {
          console.error('Error saving rating:', err);
        }
      }

      function generatePDF(filterType) {
        const ratedFoods = Object.entries(myRatings)
          .map(([key, rating]) => {
            const food = foodDatabase.find(f => f.id === parseInt(key));
            return food ? { food, rating } : null;
          })
          .filter(item => {
            if (!item) return false;
            if (filterType === "tolerate" && item.rating.rating !== "tolerate") return false;
            if (filterType === "moderation" && item.rating.rating !== "moderation") return false;
            if (filterType === "avoid" && item.rating.rating !== "avoid") return false;
            return true;
          })
          .sort((a, b) => {
            if (a.food.category < b.food.category) return -1;
            if (a.food.category > b.food.category) return 1;
            return a.food.name.localeCompare(b.food.name);
          });

        const title = filterType === "all" ? "All My Ratings" : 
                    filterType === "tolerate" ? "What I Can Eat" :
                    filterType === "moderation" ? "In Moderation" : "What I Should Avoid";

        // Organize foods by rating type and category for 3-column layout
        const organizeByRatingAndCategory = (foods, ratingType) => {
          const filtered = foods.filter(item => item.rating.rating === ratingType);
          const byCategory = {};
          
          filtered.forEach(item => {
            if (!byCategory[item.food.category]) {
              byCategory[item.food.category] = [];
            }
            byCategory[item.food.category].push(item.food.name);
          });
          
          return byCategory;
        };

        const tolerateByCategory = organizeByRatingAndCategory(ratedFoods, "tolerate");
        const moderationByCategory = organizeByRatingAndCategory(ratedFoods, "moderation");
        const avoidByCategory = organizeByRatingAndCategory(ratedFoods, "avoid");

        // Build content for a column
        const buildColumnContent = (byCategory, color, symbol) => {
          const content = [];
          Object.keys(byCategory).sort().forEach(category => {
            content.push({
              text: category.toUpperCase(),
              fontSize: 10,
              bold: true,
              color: '#666666',
              margin: [0, 8, 0, 4]
            });
            byCategory[category].forEach(foodName => {
              content.push({
                text: `  ${foodName}`,
                fontSize: 9,
                color: color,
                margin: [0, 2, 0, 2]
              });
            });
          });
          return content.length > 0 ? content : [{ text: 'None yet', fontSize: 9, color: '#999999', italics: true }];
        };

        // Define PDF document structure
        const docDefinition = {
          pageSize: 'A4',
          pageMargins: [40, 60, 40, 60],
          content: [
            // Header
            {
              text: 'HistaBase',
              fontSize: 28,
              bold: true,
              color: '#525174',
              alignment: 'center',
              margin: [0, 0, 0, 5]
            },
            {
              text: title.toUpperCase(),
              fontSize: 16,
              color: '#525174',
              alignment: 'center',
              margin: [0, 0, 0, 20]
            },
            {
              text: `Generated: ${new Date().toLocaleDateString()}`,
              fontSize: 10,
              color: '#666666',
              alignment: 'center',
              margin: [0, 0, 0, 5]
            },
            ...(userConditions.length > 0 ? [{
              text: `My Conditions: ${userConditions.join(", ")}`,
              fontSize: 10,
              color: '#666666',
              alignment: 'center',
              margin: [0, 0, 0, 20]
            }] : [{ text: '', margin: [0, 0, 0, 20] }]),
            
            // Separator line
            {
              canvas: [
                {
                  type: 'line',
                  x1: 0, y1: 0,
                  x2: 515, y2: 0,
                  lineWidth: 1,
                  lineColor: '#E5E7EB'
                }
              ],
              margin: [0, 0, 0, 20]
            },

            // 3-column layout
            {
              columns: [
                {
                  width: '*',
                  stack: [
                    {
                      text: 'I CAN EAT',
                      fontSize: 12,
                      bold: true,
                      color: '#00A676',
                      margin: [0, 0, 0, 10]
                    },
                    ...buildColumnContent(tolerateByCategory, '#00A676', '')
                  ]
                },
                {
                  width: '*',
                  stack: [
                    {
                      text: 'IN MODERATION',
                      fontSize: 12,
                      bold: true,
                      color: '#FBAF00',
                      margin: [0, 0, 0, 10]
                    },
                    ...buildColumnContent(moderationByCategory, '#FBAF00', '')
                  ]
                },
                {
                  width: '*',
                  stack: [
                    {
                      text: 'I SHOULD AVOID',
                      fontSize: 12,
                      bold: true,
                      color: '#BB342F',
                      margin: [0, 0, 0, 10]
                    },
                    ...buildColumnContent(avoidByCategory, '#BB342F', '')
                  ]
                }
              ],
              columnGap: 20
            }
          ],
          footer: function(currentPage, pageCount) {
            return {
              text: `Page ${currentPage} of ${pageCount}`,
              alignment: 'center',
              fontSize: 9,
              color: '#999999',
              margin: [0, 20, 0, 0]
            };
          },
          defaultStyle: {
            font: 'Roboto'
          }
        };

        pdfMake.createPdf(docDefinition).download(`histabase-${filterType}.pdf`);
        setShowDownloadMenu(false);
      }

      async function handleAuth(e) {
        e.preventDefault();
        setAuthError("");
        setAuthLoading(true);


        try {
          if (authMode === "login") {
            const { data, error } = await supabase.auth.signInWithPassword({
              email: authEmail,
              password: authPassword
            });
            if (error) throw error;
          } else {
            const { data, error } = await supabase.auth.signUp({
              email: authEmail,
              password: authPassword
            });
            if (error) throw error;
            setAuthError("Account created! You can now login.");
          }
          setShowAuthModal(false);
          setAuthEmail("");
          setAuthPassword("");
        } catch (err) {
          console.error('Auth error:', err);
          setAuthError(err.message);
        } finally {
          setAuthLoading(false);
        }
      }

      async function handleLogout() {
        console.log('[LOGOUT] Starting...');
        await supabase.auth.signOut();
        setUser(null);
        setUserConditions(["Histamine Intolerance"]);
        setMyRatings({});
        setDefaultDiet("all");
        setDietFilter("all");
        await loadCommunityRatings();
      }

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4" style={{ borderColor: '#525174' }}></div>
              <p className="text-gray-600">Loading HistaBase...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
            <div className="bg-white rounded-lg p-8 max-w-md border border-red-200">
              <div className="flex items-center gap-3 mb-4">
                <XCircle className="w-8 h-8 text-red-500" />
                <h2 className="text-xl font-semibold text-gray-800">Failed to Load Database</h2>
              </div>
              <p className="text-gray-600 mb-4">{error}</p>
              <p className="text-sm text-gray-500">Make sure the DATABASE_URL is correct and accessible.</p>
            </div>
          </div>
        );
      }

      const filteredFoods = getFilteredFoods();
      const tolerateList = Object.entries(myRatings).filter(([_, v]) => v.rating === "tolerate");
      const moderationList = Object.entries(myRatings).filter(([_, v]) => v.rating === "moderation");
      const avoidList = Object.entries(myRatings).filter(([_, v]) => v.rating === "avoid");

      function FoodCard({ food, showCategoryDivider, categoryName }) {
        const isExp = expanded === food.id;
        const stats = getCommunityStats(food.id);
        const myRating = myRatings[food.id];
        const userScorePercentage = getUserScorePercentage(food.id);
        
        return (
          <>
            {showCategoryDivider && (
              <div className="bg-gray-200 px-4 py-2 font-semibold text-gray-700 text-sm sticky top-0 z-10">
                {categoryName}
              </div>
            )}
            <div className="bg-white rounded-lg border border-gray-100 mb-2">
              <div 
                className="px-4 py-3 cursor-pointer food-card-inner flex items-center gap-3" 
                onClick={() => setExpanded(isExp ? null : food.id)}
              >
                <div className="food-card-first-row flex items-center gap-2 flex-1 min-w-0">
                  <div className="flex-shrink-0">
                    {getScoreIcon(food.level)}
                  </div>
                  <span className="font-medium text-gray-800 text-base truncate">{food.name}</span>
                  {myRating && (
                    <span className="text-base flex-shrink-0" style={{ color: myRating.rating === "tolerate" ? '#00A676' : myRating.rating === "moderation" ? '#FBAF00' : '#BB342F' }}>
                      {myRating.rating === "tolerate" ? "\u25B2" : myRating.rating === "moderation" ? "\u25CF" : "\u25BC"}
                    </span>
                  )}
                </div>
                <div className="food-card-second-row flex items-center gap-3 ml-auto flex-shrink-0">
                  {!isExp && (
                    <div className="flex gap-1 w-[96px]" onClick={(e) => e.stopPropagation()}>
                      <button
                        onClick={() => submitRating(food.id, "tolerate")}
                        className={`vote-button w-8 h-8 flex items-center justify-center text-lg transition-colors ${
                          myRating && myRating.rating === "tolerate" ? "" : "text-gray-300"
                        }`}
                        style={myRating && myRating.rating === "tolerate" ? { color: '#00A676' } : {}}
                        onMouseEnter={(e) => !myRating && (e.target.style.color = '#00A676')}
                        onMouseLeave={(e) => !myRating && (e.target.style.color = '')}
                      >
                        {'\u25B2'}
                      </button>
                      <button
                        onClick={() => submitRating(food.id, "moderation")}
                        className={`vote-button w-8 h-8 flex items-center justify-center text-lg transition-colors ${
                          myRating && myRating.rating === "moderation" ? "" : "text-gray-300"
                        }`}
                        style={myRating && myRating.rating === "moderation" ? { color: '#FBAF00' } : {}}
                        onMouseEnter={(e) => !myRating && (e.target.style.color = '#FBAF00')}
                        onMouseLeave={(e) => !myRating && (e.target.style.color = '')}
                      >
                        {'\u25CF'}
                      </button>
                      <button
                        onClick={() => submitRating(food.id, "avoid")}
                        className={`vote-button w-8 h-8 flex items-center justify-center text-lg transition-colors ${
                          myRating && myRating.rating === "avoid" ? "" : "text-gray-300"
                        }`}
                        style={myRating && myRating.rating === "avoid" ? { color: '#BB342F' } : {}}
                        onMouseEnter={(e) => !myRating && (e.target.style.color = '#BB342F')}
                        onMouseLeave={(e) => !myRating && (e.target.style.color = '')}
                      >
                        {'\u25BC'}
                      </button>
                    </div>
                  )}
                  {isExp && <div className="w-[96px]"></div>}
                  <span className="px-3 py-1 rounded-full text-sm font-semibold min-w-[60px] text-center text-white" style={{ backgroundColor: '#A7ACD9' }}>
                    {userScorePercentage !== null ? `${userScorePercentage}%` : '--'}
                  </span>
                  <span className={`px-3 py-1 rounded-full text-white text-sm font-medium whitespace-nowrap min-w-[80px] text-center ${getScoreColor(food.score)}`}>
                    {getScoreLabel(food.level)}
                  </span>
                  {isExp ? <ChevronUp className="w-5 h-5 text-gray-400 flex-shrink-0" /> : <ChevronDown className="w-5 h-5 text-gray-400 flex-shrink-0" />}
                </div>
              </div>
              {isExp && (
                <div className="px-4 pb-4 border-t border-gray-100 pt-3">
                  <p className="text-gray-500 text-sm mb-2">{food.category}</p>
                  <p className="text-gray-600 text-base mb-3">{food.description}</p>
                  <div className="bg-gray-50 rounded p-3 mb-3" style={{ backgroundColor: '#BFDBFE80' }}>
                    <p className="text-sm font-medium text-gray-700 mb-2">
                      Database Score: {food.score === -1 ? <span className="text-gray-400">N/A</span> : 
                        <span style={{ color: food.score === 0 ? '#00A676' : food.score <= 2 ? '#FBAF00' : '#BB342F' }}>
                          {food.score}/3
                        </span>
                      }
                    </p>
                    <div className="flex flex-wrap gap-1">
                      {food.sources.map((s, i) => (
                        <span key={i} className="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">
                          {s === "CFCD" ? "CFCD (No Histamine Data)" : s}
                        </span>
                      ))}
                    </div>
                  </div>
                  {stats && (
                    <div className="rounded p-3 mb-3" style={{ backgroundColor: '#8B7FC350' }}>
                      <p className="text-sm font-medium text-gray-700 mb-3 flex items-center gap-1">
                        <Users className="w-4 h-4" /> Community Reports
                      </p>
                      <BarGraph 
                        tolerable={stats.total.tolerable} 
                        moderate={stats.total.moderate}
                        intolerable={stats.total.intolerable} 
                        label="Total" 
                        isTotal={true} 
                      />
                      {Object.keys(stats.byCondition).map(c => (
                        <BarGraph 
                          key={c} 
                          tolerable={stats.byCondition[c].tolerable} 
                          moderate={stats.byCondition[c].moderate}
                          intolerable={stats.byCondition[c].intolerable} 
                          label={c} 
                          isTotal={false} 
                        />
                      ))}
                    </div>
                  )}
                  <div className="flex gap-2">
                    <button
                      onClick={(e) => { e.stopPropagation(); submitRating(food.id, "tolerate"); }}
                      className={`flex-1 py-2 rounded text-sm font-medium flex items-center justify-center gap-1 transition-colors ${
                        myRating && myRating.rating === "tolerate" ? "text-white" : "text-gray-700 hover:bg-green-200"
                      }`}
                      style={myRating && myRating.rating === "tolerate" ? { backgroundColor: '#00A676' } : { backgroundColor: '#00A67633' }}
                    >
                      {'\u25B2'} I tolerate
                    </button>
                    <button
                      onClick={(e) => { e.stopPropagation(); submitRating(food.id, "moderation"); }}
                      className={`flex-1 py-2 rounded text-sm font-medium flex items-center justify-center gap-1 transition-colors ${
                        myRating && myRating.rating === "moderation" ? "text-white" : "text-gray-700 hover:bg-yellow-200"
                      }`}
                      style={myRating && myRating.rating === "moderation" ? { backgroundColor: '#FBAF00' } : { backgroundColor: '#FBAF0033' }}
                    >
                      {'\u25CF'} In moderation
                    </button>
                    <button
                      onClick={(e) => { e.stopPropagation(); submitRating(food.id, "avoid"); }}
                      className={`flex-1 py-2 rounded text-sm font-medium flex items-center justify-center gap-1 transition-colors ${
                        myRating && myRating.rating === "avoid" ? "text-white" : "text-gray-700 hover:bg-red-200"
                      }`}
                      style={myRating && myRating.rating === "avoid" ? { backgroundColor: '#BB342F' } : { backgroundColor: '#BB342F33' }}
                    >
                      {'\u25BC'} I react
                    </button>
                  </div>
                </div>
              )}
            </div>
          </>
        );
      }

      return (
        <div className="min-h-screen" style={{ backgroundColor: '#FAF9F7' }}>
          <div className="flex-1 mx-auto px-4 py-6" style={{ maxWidth: '852px' }}>
            <div className="mx-auto">
              <div className="text-center mb-6 mobile-header">
                <div className="flex items-center mb-2 mobile-auth-buttons">
                  <div className="flex-1"></div>
                  <div className="text-center">
                    <h1 className="text-xl md:text-2xl font-bold" style={{ color: '#525174' }}>HistaBase</h1>
                    <p className="text-gray-400 text-xs md:text-sm">The histamine food database</p>
                  </div>
                  <div className="flex-1 flex items-center gap-2 ml-6">
                    {user ? (
                      <>
                        <button
                          onClick={handleLogout}
                          className="flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-white"
                          style={{ backgroundColor: '#A7ACD9' }}
                        >
                          <LogOut className="w-3 h-3 md:w-4 md:h-4" /> Logout
                        </button>
                        <span className="hidden sm:inline text-sm font-medium text-gray-600">
                          {user.email.split('@')[0]}
                        </span>
                      </>
                    ) : (
                      <button
                        onClick={() => setShowAuthModal(true)}
                        className="flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-white"
                        style={{ backgroundColor: '#A7ACD9' }}
                      >
                        <LogIn className="w-3 h-3 md:w-4 md:h-4" /> Login
                      </button>
                    )}
                  </div>
                </div>
              </div>
              <div className="flex gap-2 mb-8 max-w-2xl mx-auto">
                <button 
                  onClick={() => setView("database")} 
                  className={`flex-1 py-2 rounded-lg font-medium text-sm ${view === "database" ? "text-white" : "bg-white text-gray-600"}`}
                  style={view === "database" ? { backgroundColor: '#525174' } : {}}
                >
                  <Search className="w-4 h-4 inline mr-1" />{translations[language].database}
                </button>
                <button 
                  onClick={() => setView("profile")} 
                  className={`flex-1 py-2 rounded-lg font-medium text-sm ${view === "profile" ? "text-white" : "bg-white text-gray-600"}`}
                  style={view === "profile" ? { backgroundColor: '#525174' } : {}}
                >
                  <User className="w-4 h-4 inline mr-1" />{translations[language].profile}
                </button>
                <button 
                  onClick={() => setView("info")} 
                  className={`flex-1 py-2 rounded-lg font-medium text-sm ${view === "info" ? "text-white" : "bg-white text-gray-600"}`}
                  style={view === "info" ? { backgroundColor: '#525174' } : {}}
                >
                  <Info className="w-4 h-4 inline mr-1" />{translations[language].info}
                </button>
              </div>
            </div>

            {view === "database" && (
              <div className="flex gap-4 items-start">
                {/* Mobile backdrop */}
                <div 
                  className={`mobile-backdrop ${mobileSidebarOpen ? 'open' : ''}`}
                  onClick={() => setMobileSidebarOpen(false)}
                ></div>

                {/* Mobile Sidebar (overlay) */}
                <div className={`mobile-sidebar ${mobileSidebarOpen ? 'open' : ''}`}>
                  <div className="p-4">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold text-gray-700">{translations[language].filters}</h3>
                      <button 
                        onClick={() => setMobileSidebarOpen(false)}
                        className="text-gray-400 hover:text-gray-600 text-2xl"
                      >
                        &times;
                      </button>
                    </div>

                    {/* Mobile Secondary Navigation */}
                    <div className="mb-6 pb-6" style={{ borderBottom: '1px solid #D8B4FE' }}>
                      <div className="grid grid-cols-3 gap-2">
                        <button
                          onClick={() => {
                            setView("database");
                            setMobileSidebarOpen(false);
                          }}
                          className="py-2 px-3 rounded-lg font-medium text-sm transition-colors"
                          style={{ 
                            backgroundColor: view === "database" ? '#525174' : '#E9D5FF',
                            color: view === "database" ? 'white' : '#525174'
                          }}
                        >
                          {translations[language].database}
                        </button>
                        <button
                          onClick={() => {
                            setView("profile");
                            setMobileSidebarOpen(false);
                          }}
                          className="py-2 px-3 rounded-lg font-medium text-sm transition-colors"
                          style={{ 
                            backgroundColor: view === "profile" ? '#525174' : '#E9D5FF',
                            color: view === "profile" ? 'white' : '#525174'
                          }}
                        >
                          {translations[language].profile}
                        </button>
                        <button
                          onClick={() => {
                            setView("info");
                            setMobileSidebarOpen(false);
                          }}
                          className="py-2 px-3 rounded-lg font-medium text-sm transition-colors"
                          style={{ 
                            backgroundColor: view === "info" ? '#525174' : '#E9D5FF',
                            color: view === "info" ? 'white' : '#525174'
                          }}
                        >
                          {translations[language].info}
                        </button>
                      </div>
                    </div>

                    <h3 className="font-semibold text-gray-700 mb-4">{translations[language].filters}</h3>

                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].language.toUpperCase()}</p>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setLanguage('en')}
                          className={`language-button p-2 rounded transition-opacity ${language === 'en' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                          title="English"
                        >
                          <FlagUS className="w-8 h-5" />
                        </button>
                        <button
                          onClick={() => setLanguage('de')}
                          className={`language-button p-2 rounded transition-opacity ${language === 'de' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                          title="Deutsch"
                        >
                          <FlagDE className="w-8 h-5" />
                        </button>
                      </div>
                    </div>

                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].diet.toUpperCase()}</p>
                      <button 
                        onClick={() => setDietFilter("all")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "all" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "all" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].allFoods}
                      </button>
                      <button 
                        onClick={() => setDietFilter("vegetarian")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "vegetarian" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "vegetarian" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].vegetarian}
                      </button>
                      <button 
                        onClick={() => setDietFilter("vegan")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "vegan" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "vegan" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].vegan}
                      </button>
                    </div>

                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].categories.toUpperCase()}</p>
                      <div>
                        {categories.map(c => (
                          <label key={c} className="flex items-center gap-2 text-gray-600 cursor-pointer py-1 text-sm">
                            <input
                              type="checkbox"
                              checked={selectedCategories.includes(c)}
                              onChange={() => {
                                setSelectedCategories(
                                  selectedCategories.includes(c)
                                    ? selectedCategories.filter(cat => cat !== c)
                                    : [...selectedCategories, c]
                                );
                              }}
                              className="w-4 h-4"
                            />
                            {c}
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].sources.toUpperCase()}</p>
                      {allSources.map(s => (
                        <label key={s} className="flex items-center gap-2 text-gray-600 cursor-pointer py-1 text-sm">
                          <input
                            type="checkbox"
                            checked={selectedSources.includes(s)}
                            onChange={() => {
                              setSelectedSources(
                                selectedSources.includes(s)
                                  ? selectedSources.filter(src => src !== s)
                                  : [...selectedSources, s]
                              );
                            }}
                            className="w-4 h-4"
                          />
                          {s === "CFCD" ? "CFCD (No Histamine Data)" : s}
                        </label>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Desktop Sidebar (always visible on desktop) */}
                {sidebarOpen && (
                  <div className="desktop-sidebar w-64 bg-gray-50 border border-gray-200 rounded-xl p-4 sticky top-4">
                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].language.toUpperCase()}</p>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setLanguage('en')}
                          className={`language-button p-2 rounded transition-opacity ${language === 'en' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                          title="English"
                        >
                          <FlagUS className="w-8 h-5" />
                        </button>
                        <button
                          onClick={() => setLanguage('de')}
                          className={`language-button p-2 rounded transition-opacity ${language === 'de' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                          title="Deutsch"
                        >
                          <FlagDE className="w-8 h-5" />
                        </button>
                      </div>
                    </div>

                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].diet.toUpperCase()}</p>
                      <button 
                        onClick={() => setDietFilter("all")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "all" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "all" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].allFoods}
                      </button>
                      <button 
                        onClick={() => setDietFilter("vegetarian")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "vegetarian" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "vegetarian" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].vegetarian}
                      </button>
                      <button 
                        onClick={() => setDietFilter("vegan")} 
                        className={`block w-full text-left px-3 py-2 rounded text-sm font-medium ${dietFilter === "vegan" ? "" : "text-gray-600 hover:bg-gray-100"}`}
                        style={dietFilter === "vegan" ? { backgroundColor: '#a7acd6', color: '#525174' } : {}}
                      >
                        {translations[language].vegan}
                      </button>
                    </div>

                    <div className="mb-4">
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].categories.toUpperCase()}</p>
                      <div>
                        {categories.map(c => (
                          <label key={c} className="flex items-center gap-2 text-gray-600 cursor-pointer py-1 text-sm">
                            <input
                              type="checkbox"
                              checked={selectedCategories.includes(c)}
                              onChange={() => {
                                setSelectedCategories(
                                  selectedCategories.includes(c)
                                    ? selectedCategories.filter(cat => cat !== c)
                                    : [...selectedCategories, c]
                                );
                              }}
                              className="w-4 h-4"
                            />
                            {c}
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <p className="font-semibold text-gray-500 mb-2 text-sm">{translations[language].sources.toUpperCase()}</p>
                      {allSources.map(s => (
                        <label key={s} className="flex items-center gap-2 text-gray-600 cursor-pointer py-1 text-sm">
                          <input
                            type="checkbox"
                            checked={selectedSources.includes(s)}
                            onChange={() => {
                              setSelectedSources(
                                selectedSources.includes(s)
                                  ? selectedSources.filter(src => src !== s)
                                  : [...selectedSources, s]
                              );
                            }}
                            className="w-4 h-4"
                          />
                          {s === "CFCD" ? "CFCD (No Histamine Data)" : s}
                        </label>
                      ))}
                    </div>
                  </div>
                )}

                <div className="flex-1 main-content">
                  <div className="relative mb-4">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                    <input
                      type="text"
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                      placeholder="Search foods..."
                      className="w-full pl-12 pr-12 py-3 rounded-lg border border-gray-200 text-base outline-none"
                    />
                    {search && (
                      <button
                        onClick={() => setSearch("")}
                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                        aria-label="Clear search"
                      >
                        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <circle cx="12" cy="12" r="10"/>
                          <path d="m15 9-6 6"/>
                          <path d="m9 9 6 6"/>
                        </svg>
                      </button>
                    )}
                  </div>
                  <div className="flex justify-between items-center mb-3">
                    <div className="flex items-center gap-3">
                      <button 
                        ref={filterButtonRef}
                        onClick={() => {
                          // Desktop: toggle sidebar visibility
                          setSidebarOpen(!sidebarOpen);
                          // Mobile: open overlay
                          if (window.innerWidth <= 768) {
                            setMobileSidebarOpen(true);
                          }
                        }}
                        className="text-sm flex items-center gap-1"
                        style={{ color: '#525174' }}
                      >
                        <Filter className="w-4 h-4" /> {sidebarOpen && window.innerWidth > 768 ? "Hide" : "Show"} Filters
                      </button>
                      <div className="flex items-center gap-3">
                        <span className="text-sm text-gray-400">{filteredFoods.length} foods</span>
                        <label className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={categorySort}
                            onChange={(e) => setCategorySort(e.target.checked)}
                            className="w-4 h-4"
                          />
                          Group by Category
                        </label>
                      </div>
                    </div>
                  </div>
                  
                  {/* Column Headers */}
                  <div className="bg-gray-50 border-y border-gray-200 mb-2">
                    <div className="px-4 py-2 flex items-center gap-3">
                      <div className="flex items-center gap-2 flex-1 min-w-0">
                        <div className="flex-shrink-0 w-5"></div>
                        <button
                          onClick={() => handleColumnSort("name")}
                          className="font-semibold text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1 transition-colors"
                        >
                          Name
                          {sortBy === "name" && (
                            <span className="text-xs">
                              {sortDirection === "asc" ? "▲" : "▼"}
                            </span>
                          )}
                        </button>
                      </div>
                      <div className="flex items-center gap-3 ml-auto flex-shrink-0">
                        <div className="w-[96px]"></div>
                        <button
                          onClick={() => handleColumnSort("userscore")}
                          className="font-semibold text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1 min-w-[60px] text-center transition-colors"
                        >
                          Community
                          {sortBy === "userscore" && (
                            <span className="text-xs">
                              {sortDirection === "asc" ? "▲" : "▼"}
                            </span>
                          )}
                        </button>
                        <button
                          onClick={() => handleColumnSort("score")}
                          className="font-semibold text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1 min-w-[80px] text-center transition-colors"
                        >
                          Database
                          {sortBy === "score" && (
                            <span className="text-xs">
                              {sortDirection === "asc" ? "▲" : "▼"}
                            </span>
                          )}
                        </button>
                        <div className="w-5"></div>
                      </div>
                    </div>
                  </div>

                  <div>
                    {filteredFoods.map((food, index) => {
                      const showCategoryDivider = categorySort && (index === 0 || filteredFoods[index - 1].category !== food.category);
                      return (
                        <FoodCard 
                          key={food.id} 
                          food={food} 
                          showCategoryDivider={showCategoryDivider}
                          categoryName={food.category}
                        />
                      );
                    })}
                    {filteredFoods.length === 0 && (
                      <p className="text-center text-gray-400 text-base py-12">No foods match filters</p>
                    )}
                  </div>
                </div>
              </div>
            )}

            {view === "profile" && (
              <div className="max-w-2xl mx-auto space-y-4">
                {user && (
                  <div className="bg-white rounded-lg p-4 border">
                    <h2 className="font-semibold text-gray-800 text-base mb-2">{translations[language].account}</h2>
                    <p className="text-sm text-gray-600">
                      {translations[language].loggedInAs} <span className="font-medium" style={{ color: '#525174' }}>{user.email}</span>
                    </p>
                  </div>
                )}
                
                <div className="bg-white rounded-lg p-4 border">
                  <h2 className="font-semibold text-gray-800 text-base mb-3">{translations[language].yourConditions}</h2>
                  <div className="flex flex-wrap gap-2">
                    {conditions.map(c => (
                      <button
                        key={c}
                        onClick={() => {
                          setUserConditions(
                            userConditions.includes(c)
                              ? userConditions.filter(cond => cond !== c)
                              : [...userConditions, c]
                          );
                        }}
                        className={`px-3 py-1 rounded-full text-sm ${
                          userConditions.includes(c) ? "text-white" : "bg-gray-100 text-gray-600"
                        }`}
                        style={userConditions.includes(c) ? { backgroundColor: '#525174' } : {}}
                      >
                        {c}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 border">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="font-semibold text-gray-800 text-base">
                      {translations[language].yourRatings} ({tolerateList.length + moderationList.length + avoidList.length})
                    </h2>
                    <div className="relative">
                      <button 
                        onClick={() => setShowDownloadMenu(!showDownloadMenu)} 
                        className="flex items-center gap-1 px-3 py-1.5 text-white rounded-lg text-sm font-medium"
                        style={{ backgroundColor: '#525174' }}
                        onMouseEnter={(e) => e.target.style.backgroundColor = '#3f3e5c'}
                        onMouseLeave={(e) => e.target.style.backgroundColor = '#525174'}
                      >
                        <Download className="w-4 h-4" /> {translations[language].downloadPDF}
                      </button>
                      {showDownloadMenu && (
                        <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg border border-gray-200 shadow-lg z-10">
                          <button 
                            onClick={() => generatePDF("tolerate")} 
                            className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg"
                          >
                            {translations[language].whatICanEat}
                          </button>
                          <button 
                            onClick={() => generatePDF("moderation")} 
                            className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                          >
                            {translations[language].inModeration}
                          </button>
                          <button 
                            onClick={() => generatePDF("avoid")} 
                            className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                          >
                            {translations[language].whatIShouldAvoid}
                          </button>
                          <button 
                            onClick={() => generatePDF("all")} 
                            className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-lg border-t"
                          >
                            {translations[language].allMyRatings}
                          </button>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <p className="text-sm font-medium mb-3" style={{ color: '#00A676' }}>{translations[language].iCanEat} ({tolerateList.length})</p>
                      <div className="space-y-2">
                        {tolerateList.map(([key, rating]) => {
                          const food = foodDatabase.find(f => f.id === parseInt(key));
                          return (
                            <div
                              key={key}
                              onClick={() => submitRating(parseInt(key), "tolerate")}
                              className="px-3 py-2 rounded text-sm flex items-center gap-2 cursor-pointer"
                              style={{ backgroundColor: '#00A67633' }}
                              onMouseEnter={(e) => e.target.style.backgroundColor = '#00A67666'}
                              onMouseLeave={(e) => e.target.style.backgroundColor = '#00A67633'}
                            >
                              <span style={{ color: '#00A676' }}>{'\u25B2'}</span>
                              <span className="text-gray-700">{food ? food.name : "Unknown"}</span>
                            </div>
                          );
                        })}
                        {tolerateList.length === 0 && <p className="text-sm text-gray-400">{translations[language].noneYet}</p>}
                      </div>
                    </div>

                    <div>
                      <p className="text-sm font-medium mb-3" style={{ color: '#FBAF00' }}>{translations[language].inModeration} ({moderationList.length})</p>
                      <div className="space-y-2">
                        {moderationList.map(([key, rating]) => {
                          const food = foodDatabase.find(f => f.id === parseInt(key));
                          return (
                            <div
                              key={key}
                              onClick={() => submitRating(parseInt(key), "moderation")}
                              className="px-3 py-2 rounded text-sm flex items-center gap-2 cursor-pointer"
                              style={{ backgroundColor: '#FBAF0033' }}
                              onMouseEnter={(e) => e.target.style.backgroundColor = '#FBAF0066'}
                              onMouseLeave={(e) => e.target.style.backgroundColor = '#FBAF0033'}
                            >
                              <span style={{ color: '#FBAF00' }}>{'\u25CF'}</span>
                              <span className="text-gray-700">{food ? food.name : "Unknown"}</span>
                            </div>
                          );
                        })}
                        {moderationList.length === 0 && <p className="text-sm text-gray-400">{translations[language].noneYet}</p>}
                      </div>
                    </div>

                    <div>
                      <p className="text-sm font-medium mb-3" style={{ color: '#BB342F' }}>{translations[language].whatIShouldAvoid} ({avoidList.length})</p>
                      <div className="space-y-2">
                        {avoidList.map(([key, rating]) => {
                          const food = foodDatabase.find(f => f.id === parseInt(key));
                          return (
                            <div
                              key={key}
                              onClick={() => submitRating(parseInt(key), "avoid")}
                              className="px-3 py-2 rounded text-sm flex items-center gap-2 cursor-pointer"
                              style={{ backgroundColor: '#BB342F33' }}
                              onMouseEnter={(e) => e.target.style.backgroundColor = '#BB342F66'}
                              onMouseLeave={(e) => e.target.style.backgroundColor = '#BB342F33'}
                            >
                              <span style={{ color: '#BB342F' }}>{'\u25BC'}</span>
                              <span className="text-gray-700">{food ? food.name : "Unknown"}</span>
                            </div>
                          );
                        })}
                        {avoidList.length === 0 && <p className="text-sm text-gray-400">None yet</p>}
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="bg-white rounded-lg p-4 border">
                  <h2 className="font-semibold text-gray-800 text-base mb-3">{translations[language].defaultDiet}</h2>
                  <p className="text-sm text-gray-600 mb-3">{translations[language].chooseDietFilter}</p>
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        setDefaultDiet("all");
                        setDietFilter("all");
                      }}
                      className={`px-4 py-2 rounded-lg text-sm font-medium ${
                        defaultDiet === "all" ? "text-white" : "bg-gray-100 text-gray-600"
                      }`}
                      style={defaultDiet === "all" ? { backgroundColor: '#525174' } : {}}
                    >
                      {translations[language].allFoods}
                    </button>
                    <button
                      onClick={() => {
                        setDefaultDiet("vegetarian");
                        setDietFilter("vegetarian");
                      }}
                      className={`px-4 py-2 rounded-lg text-sm font-medium ${
                        defaultDiet === "vegetarian" ? "text-white" : "bg-gray-100 text-gray-600"
                      }`}
                      style={defaultDiet === "vegetarian" ? { backgroundColor: '#525174' } : {}}
                    >
                      {translations[language].vegetarian}
                    </button>
                    <button
                      onClick={() => {
                        setDefaultDiet("vegan");
                        setDietFilter("vegan");
                      }}
                      className={`px-4 py-2 rounded-lg text-sm font-medium ${
                        defaultDiet === "vegan" ? "text-white" : "bg-gray-100 text-gray-600"
                      }`}
                      style={defaultDiet === "vegan" ? { backgroundColor: '#525174' } : {}}
                    >
                      Vegan
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-lg p-4 border">
                  <h2 className="font-semibold text-gray-800 text-base mb-3">Default Language</h2>
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        setDefaultLanguage('en');
                        setLanguage('en');
                      }}
                      className={`language-button p-2 rounded transition-opacity ${defaultLanguage === 'en' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                      title="English"
                    >
                      <FlagUS className="w-8 h-5" />
                    </button>
                    <button
                      onClick={() => {
                        setDefaultLanguage('de');
                        setLanguage('de');
                      }}
                      className={`language-button p-2 rounded transition-opacity ${defaultLanguage === 'de' ? 'opacity-100' : 'opacity-40 hover:opacity-70'}`}
                      title="Deutsch"
                    >
                      <FlagDE className="w-8 h-5" />
                    </button>
                  </div>
                </div>

                <div className="rounded-lg p-4 border" style={{ backgroundColor: '#faf8fc', borderColor: '#D8B4FE' }}>
                  <h3 className="font-semibold text-gray-800 text-base mb-2">{translations[language].aboutYourRatings}</h3>
                  <div className="space-y-2 text-sm text-gray-600">
                    <div className="flex items-start gap-2">
                      <span className="font-bold" style={{ color: '#00A676' }}>{'\u25B2'}</span>
                      <div>
                        <strong>{translations[language].iCanEat}:</strong> {translations[language].canEatDesc}
                      </div>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="font-bold" style={{ color: '#FBAF00' }}>{'\u25CF'}</span>
                      <div>
                        <strong>{translations[language].inModeration}:</strong> {translations[language].moderationDesc}
                      </div>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="font-bold" style={{ color: '#BB342F' }}>{'\u25BC'}</span>
                      <div>
                        <strong>{translations[language].whatIShouldAvoid}:</strong> {translations[language].avoidDesc}
                      </div>
                    </div>
                  </div>
                  <div className="mt-3 pt-3 border-t text-xs text-gray-600" style={{ borderColor: '#D8B4FE' }}>
                    {translations[language].allVotesAnonymous}
                  </div>
                </div>
              </div>
            )}

            {view === "info" && (
              <div className="max-w-2xl mx-auto space-y-4">
                <div className="bg-white rounded-lg p-5 border">
                  <h2 className="font-semibold text-gray-800 text-lg mb-3">{translations[language].aboutTitle}</h2>
                  <p className="text-base text-gray-600 mb-4">
                    {translations[language].aboutP1}
                  </p>
                  <p className="text-base text-gray-600 mb-4">
                    {translations[language].aboutP2}
                  </p>
                  <p className="text-base text-gray-600">
                    {translations[language].aboutP3}
                  </p>
                </div>

                <div className="bg-white rounded-lg p-5 border">
                  <h2 className="font-semibold text-gray-800 text-lg mb-3">{translations[language].sourcesTitle}</h2>
                  <div className="space-y-2">
                    {Object.keys(sourceLinks).map(name => (
                      <a
                        key={name}
                        href={sourceLinks[name]}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-2 text-sm hover:underline"
                        style={{ color: '#525174' }}
                      >
                        <ExternalLink className="w-4 h-4" /> {name}
                      </a>
                    ))}
                  </div>
                </div>

                <div className="bg-white rounded-lg p-5 border">
                  <h2 className="font-semibold text-gray-800 text-lg mb-3 flex items-center gap-2">
                    <Mail className="w-5 h-5" /> {translations[language].contactTitle}
                  </h2>
                  <p className="text-base text-gray-600">
                    {translations[language].contactText} <span style={{ color: '#525174' }}>{translations[language].contactEmail}</span>
                  </p>
                </div>

                <div className="bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-5 border border-pink-100">
                  <h2 className="font-semibold text-gray-800 text-lg mb-3 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-pink-500" /> {translations[language].supportTitle}
                  </h2>
                  <p className="text-base text-gray-600 mb-3">{translations[language].supportText}</p>
                  <a 
                    href="https://www.paypal.com/donate/?hosted_button_id=NYTSTRHQFJEE8"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-block bg-pink-500 text-white px-4 py-2 rounded-lg text-base font-medium hover:bg-pink-600"
                  >
                    {translations[language].donateButton}
                  </a>
                </div>
              </div>
            )}

            {showModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-5 max-w-sm w-full">
                  <h3 className="font-semibold text-lg mb-3">{translations[language].setConditionsFirst}</h3>
                  <p className="text-base text-gray-600 mb-4">
                    {translations[language].selectCondition}
                  </p>
                  <button 
                    onClick={() => { setShowModal(false); setView("profile"); }} 
                    className="w-full py-3 text-white rounded-lg text-base font-medium"
                    style={{ backgroundColor: '#525174' }}
                    onMouseEnter={(e) => e.target.style.backgroundColor = '#3f3e5c'}
                    onMouseLeave={(e) => e.target.style.backgroundColor = '#525174'}
                  >
                    {translations[language].goToProfile}
                  </button>
                </div>
              </div>
            )}

            {/* Floating filter icon button - only visible on mobile, hidden on 'data' and 'info' tabs*/}
            {window.innerWidth <= 768 && view !== "data" && view !== "info" && (
              <button
                onClick={() => {
                  setMobileSidebarOpen(true);
                }}
                className="floating-filter-icon"
                style={{
                background: 'none',
                border: 'none',
                boxShadow: 'none',
                 filter: 'none',
                 borderRadius: 0,
                  outline: 'none'
                 }}
                title="Show Filters"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{ color: '#525174' }}>
                  <line x1="4" y1="6" x2="20" y2="6" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="4" y1="12" x2="20" y2="12" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="4" y1="18" x2="20" y2="18" strokeWidth="2" strokeLinecap="round"/>
                </svg>
              </button>
            )}

            {showAuthModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-6 max-w-md w-full">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-semibold text-xl">
                      {authMode === "login" ? "Login" : "Sign Up"}
                    </h3>
                    <button 
                      onClick={() => {
                        setShowAuthModal(false);
                        setAuthError("");
                        setAuthEmail("");
                        setAuthPassword("");
                      }}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      &times;
                    </button>
                  </div>
                  
                  <form onSubmit={handleAuth} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Email
                      </label>
                      <input
                        type="email"
                        value={authEmail}
                        onChange={(e) => setAuthEmail(e.target.value)}
                        required
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
                        style={{ focusRingColor: '#525174' }}
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Password
                      </label>
                      <input
                        type="password"
                        value={authPassword}
                        onChange={(e) => setAuthPassword(e.target.value)}
                        required
                        minLength={6}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
                        style={{ focusRingColor: '#525174' }}
                      />
                    </div>

                    {authError && (
                      <p className={`text-sm ${authError.includes('Check your email') ? 'text-green-600' : 'text-red-600'}`}>
                        {authError}
                      </p>
                    )}

                    <button
                      type="submit"
                      disabled={authLoading}
                      className="w-full py-3 text-white rounded-lg text-base font-medium disabled:opacity-50"
                      style={{ backgroundColor: '#525174' }}
                    >
                      {authLoading ? "Loading..." : authMode === "login" ? "Login" : "Sign Up"}
                    </button>

                    <p className="text-center text-sm text-gray-600">
                      {authMode === "login" ? "Don't have an account? " : "Already have an account? "}
                      <button
                        type="button"
                        onClick={() => {
                          setAuthMode(authMode === "login" ? "signup" : "login");
                          setAuthError("");
                        }}
                        className="font-medium"
                        style={{ color: '#525174' }}
                      >
                        {authMode === "login" ? "Sign Up" : "Login"}
                      </button>
                    </p>
                  </form>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<HistaBase />, document.getElementById('root'));
  </script>
</body>
</html>
